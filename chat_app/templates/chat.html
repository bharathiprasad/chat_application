<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Chat - Room</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .chat-container {
            height: 75vh;
        }
        .messages-container {
            height: calc(100% - 80px);
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        .typing-indicator:after {
            content: '...';
            animation: typing-dots 1.5s infinite;
            display: inline-block;
            width: 1em;
            text-align: left;
        }
        @keyframes typing-dots {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }
        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
        }
        .user-list-item.active {
            background-color: rgba(59, 130, 246, 0.1);
        }
        .notification {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-animation {
            animation: messageAppear 0.3s ease-out;
        }
        @keyframes messageAppear {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .disconnect-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Disconnect Overlay -->
    <div id="disconnect-overlay" class="disconnect-overlay hidden">
        <div class="bg-white rounded-lg p-8 max-w-md text-center">
            <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
            <h2 class="text-xl font-bold text-gray-800 mb-2">Connection Lost</h2>
            <p class="text-gray-600 mb-6">You've been disconnected from the server</p>
            <button id="reconnect-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700 mr-3">
                <i class="fas fa-sync-alt mr-2"></i>Reconnect
            </button>
            <button id="back-to-signin-btn" class="bg-gray-600 text-white px-6 py-2 rounded-md hover:bg-gray-700">
                <i class="fas fa-arrow-left mr-2"></i>Back to Sign In
            </button>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- App Header -->
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center">
                <h1 class="text-3xl font-bold text-indigo-600 flex items-center">
                    <i class="fas fa-comments mr-2"></i> WebSocket Chat
                </h1>
                <div class="ml-6 text-sm text-gray-600">
                    <span>Room: </span>
                    <span id="current-room-display" class="font-semibold text-indigo-600"></span>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div id="user-info" class="text-sm text-gray-600">
                    <i class="fas fa-user mr-1"></i>
                    <span id="username-display"></span>
                </div>
                <div id="connection-status" class="flex items-center">
                    <span class="h-3 w-3 rounded-full bg-green-500 mr-2"></span>
                    <span class="text-sm text-gray-600">Connected</span>
                </div>
                <button id="leave-chat-btn" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 text-sm">
                    <i class="fas fa-sign-out-alt mr-1"></i>Leave
                </button>
            </div>
        </header>

        <!-- Main Chat Area -->
        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Sidebar - Users and Room Info -->
            <div class="w-full lg:w-1/4 bg-white rounded-lg shadow-md overflow-hidden">
                <div class="p-4 border-b border-gray-200 bg-indigo-50">
                    <h2 class="font-semibold text-indigo-700 flex items-center">
                        <i class="fas fa-users mr-2"></i>Active Users
                        <span id="user-count" class="ml-auto bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full text-xs">0</span>
                    </h2>
                </div>
                <div class="p-4">
                    <div id="user-list" class="space-y-1">
                        <p class="text-gray-500 text-sm">Loading users...</p>
                    </div>
                </div>
                
                <!-- Room Actions -->
                <div class="p-4 border-t border-gray-200">
                    <button id="change-room-btn" class="w-full bg-indigo-100 text-indigo-700 px-4 py-2 rounded-md hover:bg-indigo-200 text-sm">
                        <i class="fas fa-exchange-alt mr-2"></i>Change Room
                    </button>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="w-full lg:w-3/4 bg-white rounded-lg shadow-md overflow-hidden">
                <div class="p-4 border-b border-gray-200 bg-indigo-50">
                    <h2 id="current-room-name" class="font-semibold text-indigo-700">Loading...</h2>
                    <div id="typing-indicator" class="text-xs text-gray-500 mt-1 hidden">
                        <span class="typing-indicator"></span>
                    </div>
                </div>

                <div class="chat-container p-4">
                    <div id="messages-container" class="messages-container">
                        <div class="text-center text-gray-500 my-8">
                            <i class="fas fa-spinner fa-spin text-4xl mb-2"></i>
                            <p>Loading messages...</p>
                        </div>
                    </div>

                    <form id="message-form" class="mt-4 flex space-x-2">
                        <input type="text" id="message-input" placeholder="Type your message..." 
                               class="flex-1 px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-400"
                               maxlength="500">
                        <button type="submit" class="px-6 py-3 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                    
                    <!-- Message character counter -->
                    <div class="text-right mt-1">
                        <span id="char-counter" class="text-xs text-gray-400">0/500</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Room Modal -->
    <div id="change-room-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Change Room</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select a Room</label>
                <select id="new-room-select" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    <option value="General">üåç General</option>
                    <option value="Random">üí¨ Random</option>
                    <option value="Support">üéß Support</option>
                    <option value="Developers">üíª Developers</option>
                    <option value="Gaming">üéÆ Gaming</option>
                    <option value="Music">üéµ Music</option>
                </select>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancel-change-room" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">Cancel</button>
                <button id="confirm-change-room" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Change Room</button>
            </div>
        </div>
    </div>

    <script>
        // Socket.io connection
        let socket;
        let currentRoom = null;
        let username = '';
        let serverUrl = '';
        let isTyping = false;
        let typingTimeout;

        // DOM elements
        const connectionStatus = document.getElementById('connection-status');
        const userList = document.getElementById('user-list');
        const userCount = document.getElementById('user-count');
        const currentRoomName = document.getElementById('current-room-name');
        const currentRoomDisplay = document.getElementById('current-room-display');
        const usernameDisplay = document.getElementById('username-display');
        const messagesContainer = document.getElementById('messages-container');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const charCounter = document.getElementById('char-counter');
        const typingIndicator = document.getElementById('typing-indicator');
        const disconnectOverlay = document.getElementById('disconnect-overlay');
        const reconnectBtn = document.getElementById('reconnect-btn');
        const backToSigninBtn = document.getElementById('back-to-signin-btn');
        const leaveChatBtn = document.getElementById('leave-chat-btn');
        const changeRoomBtn = document.getElementById('change-room-btn');
        const changeRoomModal = document.getElementById('change-room-modal');
        const newRoomSelect = document.getElementById('new-room-select');
        const cancelChangeRoom = document.getElementById('cancel-change-room');
        const confirmChangeRoom = document.getElementById('confirm-change-room');

        // Initialize chat on page load
        window.addEventListener('load', () => {
            const userData = localStorage.getItem('chatUserData');
            
            if (!userData) {
                // No user data, redirect to sign in
                window.location.href = 'index.html';
                return;
            }

            try {
                const data = JSON.parse(userData);
                username = data.username;
                serverUrl = data.serverUrl;
                currentRoom = data.room;
                
                // Update UI
                usernameDisplay.textContent = username;
                currentRoomDisplay.textContent = currentRoom;
                currentRoomName.textContent = currentRoom;
                
                // Connect to server
                connectSocket();
            } catch (error) {
                console.error('Error parsing user data:', error);
                window.location.href = 'index.html';
            }
        });

        // Connect to Socket.io server
        function connectSocket() {
            socket = io(serverUrl, {
                transports: ['websocket'],
                reconnectionAttempts: 5,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000
            });

            // Socket event handlers
            socket.on('connect', () => {
                updateConnectionStatus(true);
                console.log('Connected to server');
                joinRoom(currentRoom);
            });

            socket.on('disconnect', () => {
                updateConnectionStatus(false);
                console.log('Disconnected from server');
                showDisconnectOverlay();
            });

            socket.on('connect_error', (error) => {
                console.error('Connection error:', error);
                updateConnectionStatus(false);
                showDisconnectOverlay();
            });

            socket.on('room_history', (data) => {
                renderMessageHistory(data.messages);
            });

            socket.on('message', (message) => {
                addNewMessage(message);
            });

            socket.on('user_joined', (data) => {
                addSystemMessage(`${data.username} joined the room`, data.timestamp);
                updateUserList(data.users);
            });

            socket.on('user_left', (data) => {
                addSystemMessage(`${data.username} left the room`, data.timestamp);
                updateUserList(data.users);
            });

            socket.on('typing', (data) => {
                if (data.username !== username && data.room === currentRoom) {
                    showTypingIndicator(data.username);
                }
            });

            socket.on('user_list', (users) => {
                updateUserList(users);
            });

            socket.on('error', (error) => {
                console.error('Socket error:', error);
                addSystemMessage(`Error: ${error.message}`, new Date().toISOString());
            });
        }

        // Update connection status UI
        function updateConnectionStatus(connected) {
            const statusDot = connectionStatus.querySelector('span');
            const statusText = connectionStatus.querySelector('span + span');

            if (connected) {
                statusDot.className = 'h-3 w-3 rounded-full bg-green-500 mr-2';
                statusText.textContent = 'Connected';
                disconnectOverlay.classList.add('hidden');
            } else {
                statusDot.className = 'h-3 w-3 rounded-full bg-red-500 mr-2';
                statusText.textContent = 'Disconnected';
            }
        }

        // Show disconnect overlay
        function showDisconnectOverlay() {
            disconnectOverlay.classList.remove('hidden');
        }

        // Join a chat room
        function joinRoom(roomName) {
            // Leave current room if any
            if (currentRoom && socket.connected) {
                socket.emit('leave_room', { room: currentRoom, username });
            }

            currentRoom = roomName;
            currentRoomName.textContent = roomName;
            currentRoomDisplay.textContent = roomName;
            messagesContainer.innerHTML = '<div class="text-center text-gray-500 my-8"><i class="fas fa-spinner fa-spin text-4xl mb-2"></i><p>Loading messages...</p></div>';

            // Emit join room event
            socket.emit('join_room', { room: roomName, username }, (response) => {
                if (response && response.error) {
                    addSystemMessage(`Error: ${response.error}`, new Date().toISOString());
                    return;
                }

                // Clear loading message
                messagesContainer.innerHTML = '';
                
                if (response && response.messages && response.messages.length > 0) {
                    renderMessageHistory(response.messages);
                } else {
                    messagesContainer.innerHTML = '<div class="text-center text-gray-500 my-8"><i class="fas fa-comment-slash text-4xl mb-2"></i><p>No messages yet</p><p class="text-sm mt-1">Start the conversation!</p></div>';
                }
            });
        }

        // Render message history
        function renderMessageHistory(messages) {
            messagesContainer.innerHTML = '';
            messages.forEach(message => {
                const isSystem = message.type === 'system';
                const isCurrentUser = message.username === username;
                addMessageToContainer(message, isSystem, isCurrentUser);
            });
            scrollToBottom();
        }

        // Add a new incoming message
        function addNewMessage(message) {
            const isSystem = message.type === 'system';
            const isCurrentUser = message.username === username;
            addMessageToContainer(message, isSystem, isCurrentUser);
            scrollToBottom();
        }

        // Add a system message
        function addSystemMessage(text, timestamp) {
            const message = {
                content: text,
                timestamp: timestamp || new Date().toISOString(),
                type: 'system'
            };
            addMessageToContainer(message