<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realtime Chat Application</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .chat-container {
            height: 75vh;
        }
        .messages-container {
            height: calc(100% - 60px);
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        .typing-indicator:after {
            content: '...';
            animation: typing-dots 1.5s infinite;
            display: inline-block;
            width: 1em;
            text-align: left;
        }
        @keyframes typing-dots {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }
        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
        }
        .user-list-item.active {
            background-color: rgba(59, 130, 246, 0.1);
        }
        .notification {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .room-selector {
            transition: all 0.3s ease;
        }
        .room-selector:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .message-animation {
            animation: messageAppear 0.3s ease-out;
        }
        @keyframes messageAppear {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- App Header -->
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-indigo-600 flex items-center">
                <i class="fas fa-comments mr-2"></i> WebSocket Chat
            </h1>
            <div id="connection-status" class="flex items-center">
                <span class="h-3 w-3 rounded-full bg-red-500 mr-2"></span>
                <span class="text-sm text-gray-600">Disconnected</span>
            </div>
        </header>

        <!-- Main Chat Area -->
        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Sidebar - Rooms and Users -->
            <div class="w-full lg:w-1/4 bg-white rounded-lg shadow-md overflow-hidden">
                <div class="p-4 border-b border-gray-200 bg-indigo-50">
                    <h2 class="font-semibold text-indigo-700">Chat Rooms</h2>
                </div>
                <div class="p-4 border-b border-gray-200">
                    <div class="flex items-center space-x-2 mb-4">
                        <input type="text" id="username-input" placeholder="Your name" 
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-400">
                    </div>
                    <div id="room-list" class="space-y-2">
                        <!-- Room selection will be added dynamically -->
                    </div>
                </div>
                <div class="p-4">
                    <h3 class="font-semibold text-indigo-700 mb-2">Active Users</h3>
                    <div id="user-list" class="space-y-1">
                        <p class="text-gray-500 text-sm">Select a room to see users</p>
                    </div>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="w-full lg:w-3/4 bg-white rounded-lg shadow-md overflow-hidden">
                <div class="p-4 border-b border-gray-200 bg-indigo-50">
                    <h2 id="current-room-name" class="font-semibold text-indigo-700">Select a room to start chatting</h2>
                    <div id="typing-indicator" class="text-xs text-gray-500 mt-1 hidden">
                        <span class="typing-indicator"></span>
                    </div>
                </div>

                <div class="chat-container p-4">
                    <div id="messages-container" class="messages-container">
                        <div class="text-center text-gray-500 my-8">
                            <i class="fas fa-comment-slash text-4xl mb-2"></i>
                            <p>No messages yet</p>
                            <p class="text-sm mt-1">Select a room and start the conversation!</p>
                        </div>
                    </div>

                    <form id="message-form" class="mt-4 flex space-x-2 hidden">
                        <input type="text" id="message-input" placeholder="Type your message..." 
                               class="flex-1 px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-400">
                        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Connection Modal -->
        <div id="connection-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white rounded-lg p-6 max-w-sm w-full">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Server Connection</h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Socket Server URL</label>
                    <input type="text" id="server-url" value="http://localhost:5000" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex justify-end space-x-3">
                    <button id="connect-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Connect</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Socket.io connection
        let socket;
        let currentRoom = null;
        let username = '';
        let isTyping = false;
        let typingTimeout;

        // Default rooms
        const defaultRooms = [
            { name: 'General', icon: 'fa-globe', activeUsers: 0 },
            { name: 'Random', icon: 'fa-comment-dots', activeUsers: 0 },
            { name: 'Support', icon: 'fa-headset', activeUsers: 0 },
            { name: 'Developers', icon: 'fa-code', activeUsers: 0 }
        ];

        // DOM elements
        const connectionStatus = document.getElementById('connection-status');
        const usernameInput = document.getElementById('username-input');
        const roomList = document.getElementById('room-list');
        const userList = document.getElementById('user-list');
        const currentRoomName = document.getElementById('current-room-name');
        const messagesContainer = document.getElementById('messages-container');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const typingIndicator = document.getElementById('typing-indicator');
        const connectionModal = document.getElementById('connection-modal');
        const serverUrlInput = document.getElementById('server-url');
        const connectButton = document.getElementById('connect-btn');

        // Show connection modal initially
        connectionModal.classList.remove('hidden');

        // Connect button click handler
        connectButton.addEventListener('click', () => {
            const serverUrl = serverUrlInput.value.trim();
            if (serverUrl) {
                connectSocket(serverUrl);
                connectionModal.classList.add('hidden');
            } else {
                alert('Please enter a valid server URL');
            }
        });

        // Connect to Socket.io server
        function connectSocket(url) {
            socket = io(url, {
                transports: ['websocket'],
                reconnectionAttempts: 5,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000
            });

            // Socket event handlers
            socket.on('connect', () => {
                updateConnectionStatus(true);
                console.log('Connected to server');
                renderRoomList();
            });

            socket.on('disconnect', () => {
                updateConnectionStatus(false);
                console.log('Disconnected from server');
            });

            socket.on('connect_error', (error) => {
                console.error('Connection error:', error);
                alert(`Failed to connect to server: ${error.message}`);
                connectionModal.classList.remove('hidden');
            });

            socket.on('room_history', (data) => {
                renderMessageHistory(data.messages);
            });

            socket.on('message', (message) => {
                addNewMessage(message);
            });

            socket.on('user_joined', (data) => {
                addSystemMessage(`${data.username} joined the room`, data.timestamp);
                updateUserList(data.users);
            });

            socket.on('user_left', (data) => {
                addSystemMessage(`${data.username} left the room`, data.timestamp);
                updateUserList(data.users);
            });

            socket.on('typing', (data) => {
                if (data.username !== username && data.room === currentRoom) {
                    showTypingIndicator(data.username);
                }
            });

            socket.on('user_list', (users) => {
                updateUserList(users);
            });

            socket.on('error', (error) => {
                console.error('Socket error:', error);
                addSystemMessage(`Error: ${error.message}`, new Date().toISOString());
            });
        }

        // Update connection status UI
        function updateConnectionStatus(connected) {
            const statusDot = connectionStatus.querySelector('span');
            const statusText = connectionStatus.querySelector('span + span');

            if (connected) {
                statusDot.className = 'h-3 w-3 rounded-full bg-green-500 mr-2';
                statusText.textContent = 'Connected';
            } else {
                statusDot.className = 'h-3 w-3 rounded-full bg-red-500 mr-2';
                statusText.textContent = 'Disconnected';
            }
        }

        // Render room list
        function renderRoomList() {
            roomList.innerHTML = '';
            defaultRooms.forEach(room => {
                const roomElement = document.createElement('div');
                roomElement.className = 'room-selector p-2 rounded-md cursor-pointer hover:bg-indigo-50 border border-gray-200';
                roomElement.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas ${room.icon} mr-2 text-indigo-500"></i>
                        <span class="font-medium">${room.name}</span>
                        <span class="ml-auto text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full">${room.activeUsers} online</span>
                    </div>
                `;
                roomElement.addEventListener('click', () => joinRoom(room.name));
                roomList.appendChild(roomElement);
            });
        }

        // Join a chat room
        function joinRoom(roomName) {
            username = usernameInput.value.trim();
            if (!username) {
                alert('Please enter your name before joining a room');
                return;
            }

            // Leave current room if any
            if (currentRoom) {
                socket.emit('leave_room', { room: currentRoom, username });
            }

            currentRoom = roomName;
            currentRoomName.textContent = roomName;
            messagesContainer.innerHTML = '';
            addSystemMessage('Loading messages...', new Date().toISOString());

            // Emit join room event
            socket.emit('join_room', { room: roomName, username }, (response) => {
                if (response.error) {
                    addSystemMessage(`Error: ${response.error}`, new Date().toISOString());
                    return;
                }

                // Clear loading message if we have history
                if (response.messages && response.messages.length > 0) {
                    messagesContainer.innerHTML = '';
                    renderMessageHistory(response.messages);
                }

                // Show message form
                messageForm.classList.remove('hidden');
            });
        }

        // Render message history
        function renderMessageHistory(messages) {
            messages.forEach(message => {
                const isSystem = message.type === 'system';
                const isCurrentUser = message.username === username;
                addMessageToContainer(message, isSystem, isCurrentUser);
            });
            scrollToBottom();
        }

        // Add a new incoming message
        function addNewMessage(message) {
            const isSystem = message.type === 'system';
            const isCurrentUser = message.username === username;
            addMessageToContainer(message, isSystem, isCurrentUser);
            scrollToBottom();
        }

        // Add a system message
        function addSystemMessage(text, timestamp) {
            const message = {
                content: text,
                timestamp: timestamp || new Date().toISOString(),
                type: 'system'
            };
            addMessageToContainer(message, true, false);
            scrollToBottom();
        }

        // Add message to container
        function addMessageToContainer(message, isSystem, isCurrentUser) {
            const messageElement = document.createElement('div');
            messageElement.className = `mb-3 message-animation ${isSystem ? 'text-center' : ''}`;

            if (isSystem) {
                messageElement.innerHTML = `
                    <span class="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded-full">${message.content}</span>
                    <div class="message-time text-xs mt-1">${formatTime(message.timestamp)}</div>
                `;
            } else {
                const messageClass = isCurrentUser ? 'bg-indigo-500 text-white' : 'bg-gray-100 text-gray-800';
                messageElement.innerHTML = `
                    <div class="flex ${isCurrentUser ? 'justify-end' : 'justify-start'} space-x-2">
                        ${!isCurrentUser ? `<span class="font-medium text-gray-700">${message.username}</span>` : ''}
                    </div>
                    <div class="flex ${isCurrentUser ? 'justify-end' : 'justify-start'} mt-1">
                        <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${messageClass}">
                            ${message.content}
                        </div>
                    </div>
                    <div class="flex ${isCurrentUser ? 'justify-end' : 'justify-start'}">
                        <div class="message-time">${formatTime(message.timestamp)}</div>
                    </div>
                `;
            }

            // Add message to container with slight delay for animation
            setTimeout(() => {
                messagesContainer.appendChild(messageElement);
            }, 50);
        }

        // Update user list
        function updateUserList(users) {
            userList.innerHTML = '';
            
            if (!users || users.length === 0) {
                userList.innerHTML = '<p class="text-gray-500 text-sm">No users in this room</p>';
                return;
            }

            users.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = `flex items-center p-2 rounded-md user-list-item ${user === username ? 'active' : ''}`;
                userElement.innerHTML = `
                    <i class="fas fa-user-circle mr-2 text-indigo-500"></i>
                    <span>${user}</span>
                    ${user === username ? '<span class="ml-auto text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full">You</span>' : ''}
                `;
                userList.appendChild(userElement);
            });
        }

        // Format timestamp
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Scroll to bottom of messages
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Show typing indicator
        function showTypingIndicator(username) {
            typingIndicator.classList.remove('hidden');
            typingIndicator.innerHTML = `${username} is typing <span class="typing-indicator"></span>`;
            
            // Hide after 3 seconds
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                typingIndicator.classList.add('hidden');
            }, 3000);
        }

        // Message form submission
        messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const messageContent = messageInput.value.trim();
            
            if (messageContent && currentRoom) {
                const message = {
                    room: currentRoom,
                    username: username,
                    content: messageContent,
                    timestamp: new Date().toISOString()
                };
                
                // Emit message
                socket.emit('message', message);
                messageInput.value = '';
                
                // Clear typing status
                clearTyping();
                socket.emit('typing', { room: currentRoom, username, isTyping: false });
            }
        });

        // Typing detection
        messageInput.addEventListener('input', () => {
            if (!isTyping) {
                isTyping = true